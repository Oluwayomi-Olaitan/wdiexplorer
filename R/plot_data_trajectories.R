utils::globalVariables(c("year", "quantile", "reorder", "threshold"))

#' Plot of data trajectories
#'
#' Generates the trajectory of each country data series and supports two plot modes: The display of all series uniformly or a mode that highlight countries with metric values within a specified percentile.
#' Each mode can be rendered in two versions: ungrouped and grouped.
#' Hovering over each highlighted line displays the corresponding country name and metric value
#'
#' @param wdi_data A data frame of the indicator data generated by \code{\link{get_wdi_data}}
#' @param index A character string specifying the indicator code
#' Defaults to `NULL`
#' @param group_var A grouping variable in the WDI data set (e.g., "region" or "income")
#' Default to `NULL`
#' If `NULL`, trajectories are ungrouped and if specified, trajectories are grouped by the levels of the variable
#' @param metric_summary A data frame containing computed diagnostic metrics and the pre-defined grouping information,
#' generated by passing the output of any diagnostic metrics function to \code{\link{add_group_info}}
#' Defaults to `NULL`. If `NULL`, data trajectories are plotted per country series
#' If specified, it highlight countries using a colour palette based on a metric threshold
#' @param metric_var Character string specifying metric variable name in `metric_summary` to plot
#' @param percentile A percentile threshold (between 0 and 1) for highlighting countries based on their metric values
#' Defaults to `0.95`, meaning countries that fall within the top 5% of `metric_var` values
#'
#' @returns An ungrouped or grouped interactive plot object displaying the trajectory of country-level data series.
#' It supports both the display of all series uniformly, and also a mode that highlight countries
#'  that fall within a specified percentile of any chosen diagnostic metric values.
#' @export
#'
#' @examples
#' pm_data <- get_wdi_data(indicator = "EN.ATM.PM25.MC.M3")
#' pm_diagnostic_metrics <- compute_diagnostic_indices(pm_data, group_var = "region")
#' pm_diagnostic_metrics_group <- add_group_info(metric_summary = pm_diagnostic_metrics,pm_data)
#' plot_data_trajectories(pm_data, group_var = "region",
#' metric_summary = pm_diagnostic_metrics_group, metric_var = "within_group_avg_dist")
plot_data_trajectories <- function(wdi_data, index = NULL, group_var = NULL, metric_summary = NULL, metric_var = NULL, percentile = 0.95){

  # Identify the name of the variable in the wdi data that contains the country-year value as index
  if(is.null(index)) {
    index_var <- attr(wdi_data, "index_var")
    index = index_var[1]
  }

  if(is.null(metric_summary) && is.null(metric_var)){
    # plot the data trajectories
    if(is.null(group_var)){
      # ungrouped plot
      P <- ggplot2::ggplot() +
        ggiraph::geom_line_interactive(
          data = stats::na.omit(wdi_data),
          ggplot2::aes(
            x = year,
            y = .data[[index]],
            group = country,
            tooltip = country,
            data_id = country
          ),
          colour = "grey65"
        ) +
        ggplot2::theme_minimal() +
        ggplot2::theme(legend.position = "none")
    } else{
      # grouped plot
      P <- ggplot2::ggplot() +
        ggiraph::geom_line_interactive(
          data = stats::na.omit(wdi_data),
          ggplot2::aes(
            x = year,
            y = .data[[index]],
            group = country,
            tooltip = country,
            data_id = country
          ),
          colour = "grey65"
        ) +
        ggplot2::facet_wrap(~.data[[group_var]]) +
        ggplot2::theme_minimal() +
        ggplot2::theme(legend.position = "none")
    }

  } else{
    # the percentile label
    percentile_label <- paste0("<=", percentile *100, "%")

    # plot the metrics with the data trajectories
    if(is.null(group_var)){
      # ungrouped plot
      # global threshold
      # joining the metric_data to the wdi_data.
      metric_data <- wdi_data |>
        dplyr::select(country, region, income, year, tidyselect::all_of(index)) |>
        dplyr::left_join(metric_summary, by = "country")

      # calculate the cutoff for the country metrics.
      cutoff_value <- quantile(metric_summary[[metric_var]], probs = percentile, na.rm = TRUE)

      # the plot
      P <- ggplot2::ggplot() +
        ggplot2::geom_line(
          data = stats::na.omit(metric_data) |>
            dplyr::filter(.data[[metric_var]] <= cutoff_value),
          ggplot2::aes(
            x = year,
            y = .data[[index]],
            group = reorder(country, .data[[metric_var]]),
            colour = "below"
          )
        ) +
        ggplot2::scale_colour_manual(
          name = NULL,
          values = c("below" = "grey"),
          labels = c("below" = percentile_label),
          guide = ggplot2::guide_legend(order = 2)
        ) +
        ggnewscale::new_scale_color() +
        ggiraph::geom_line_interactive(
          data = stats::na.omit(metric_data) |>
            dplyr::filter(.data[[metric_var]] > cutoff_value),
          ggplot2::aes(
            x = year,
            y = .data[[index]],
            group = reorder(country, .data[[metric_var]]),
            colour = .data[[metric_var]],
            tooltip = paste(
              "Country:", country,
              "<br>Value:", sprintf("%.2f", .data[[metric_var]])),
            data_id = country
          )
        ) +
        ggplot2::scale_colour_viridis_c(
          option = "C",
          direction = -1,
          name = paste0(metric_var, "\n (Top ", round((1 - percentile) * 100), "%)"),
          guide = ggplot2::guide_colorbar(order = 1)
        ) +
        ggplot2::theme_classic()+
        ggplot2::theme(
          legend.spacing.y = ggplot2::unit(0.2, "cm")
        )
    } else{
      # compute group quantile threshold
      group_metric <- metric_summary |>
        dplyr::group_by(.data[[group_var]]) |>
        dplyr::mutate(
          threshold = quantile(.data[[metric_var]],
                               probs = percentile,
                               na.rm = TRUE)
        )

      # join the group_metric to the wdi_data
      wdi_data |>
        dplyr::select(country, year, tidyselect::all_of(index)) |>
        dplyr::left_join(group_metric, by = "country") -> group_metric_data

      # the faceted plot
      P <- ggplot2::ggplot() +
        ggplot2::geom_line(
          data = stats::na.omit(group_metric_data) |>
            dplyr::filter(.data[[metric_var]] <= threshold),
          ggplot2::aes(
            x = year,
            y = .data[[index]],
            group = reorder(country, .data[[metric_var]]),
            colour = "below"
          )
        ) +
        ggplot2::scale_colour_manual(
          name = NULL,
          values = c("below" = "grey"),
          labels = c("below" = percentile_label),
          guide = ggplot2::guide_legend(order = 2)
        ) +
        ggnewscale::new_scale_color() +
        ggiraph::geom_line_interactive(
          data = stats::na.omit(group_metric_data) |>
            dplyr::filter(.data[[metric_var]] > threshold),
          ggplot2::aes(
            x = year,
            y = .data[[index]],
            group = reorder(country, .data[[metric_var]]),
            colour = .data[[metric_var]],
            tooltip = paste(
              "Country:", country,
              "<br>Value:", sprintf("%.2f", .data[[metric_var]])),
            data_id = country
          )
        ) +
        ggplot2::scale_colour_viridis_c(
          option = "C",
          direction = -1,
          name = paste0(metric_var, "\n (Top ", round((1 - percentile) * 100), "%)"),
          guide = ggplot2::guide_colorbar(order = 1)
        ) +
        ggplot2::facet_wrap(stats::as.formula(paste("~", group_var))) +
        ggplot2::theme_classic()+
        ggplot2::theme(
          legend.spacing.y = ggplot2::unit(0.2, "cm")
        )
    }
  }

  # Interactive plot
  ggiraph::girafe(
    ggobj = P,
    width_svg = 10,
    height_svg = 6,
    options = list(
      ggiraph::opts_hover_inv(css = "opacity: 0.1;"),  # makes non-hovered lines fade
      ggiraph::opts_hover(css = "opacity: 1; stroke-width: 2;")  # on hover: no color change
    )
  )
}
